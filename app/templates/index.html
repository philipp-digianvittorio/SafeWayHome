{% extends "base.html" %}

{% block content %}
    <br>
    <div class="container position-relative">

        <div class="container">
            <div class="row">
                <div class="col-10 offset-1 mt-5">
                    <div class="card text-center" style="background: rgba(255, 255, 255, 0.8)">
                        <div class="card-body">
                            <h5 class="card-title">Enter your Route</h5>

                            <form method="post" action="#">
                                <div class="input-group mb-3">
                                    <input id="start_loc" class="form-control" placeholder="start" value="" name="start_loc">
                                    <button onclick="trackLocation()" class="btn btn-secondary" type="button" id="button-addon2"><span class="bi bi-geo-alt-fill"></span></button>
                                </div>

                                <div class="mb-3 d-none">
                                    <input id="user_position" class="form-control" value="" name="user_position">
                                </div>

                                <div class="mb-3">
                                    <input id="destination_loc" class="form-control" placeholder="destination" name="destination_loc">
                                </div>
                                <button type="submit" class="btn btn-primary">Show Routes</button>
                            </form>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div id = "map" class="position-relative" style = "width: 100%; height: 100vh;"></div>
                </div>
            </div>
        </div>

    </div>


    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <script>

    const route = {{ route|safe }};
    console.log(route);


     window.onload = function() {
        document.getElementById('start_loc').value = '';
     }

     // Creating map options, insert coordinates
     var mapOptions = {
        center: [50.115459, 8.679118],
        zoom: 13
     }

     // Creating a map object
     var map = new L.map('map', mapOptions);

     // Creating a Layer object
     var layer = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');

     // Adding layer to the map
     map.addLayer(layer);

     L.Control.geocoder().addTo(map);


     // ask user to enable location tracking
     function trackLocation() {
         if (!navigator.geolocation) {
            console.log("Your browser doesn't support geolocation feature!")
         } else {
            navigator.geolocation.getCurrentPosition(showSuccessMessage, showErrorMessage)
         };
     }

     function showSuccessMessage(position) {
        const start_loc = document.getElementById("start_loc")
        start_loc.value = "Mein Standort"

        const user_pos = document.getElementById("user_position")
        user_pos.value = position.coords.latitude + "," + position.coords.longitude
        console.log(document.getElementById("user_position").value)
     }

     function showErrorMessage() {
        const start_loc = document.getElementById("start_loc");
        start_loc.value = "Standort nicht freigegeben";
        console.log("nicht freigegeben")
     }


     if (route["valid_coords"])  {

        var marker_start = L.marker(route["start_coords"])
        var marker_dest = L.marker(route["dest_coords"])

        L.Routing.control({
           waypoints:   [
           L.latLng(route["start_coords"][0], route["start_coords"][1]),
           L.latLng(route["dest_coords"][0], route["dest_coords"][1])
           ]
        }).addTo(map);

        var featureGroup = L.featureGroup([marker_start, marker_dest]).addTo(map)

        map.fitBounds(featureGroup.getBounds())

         //if (!navigator.geolocation) {
         //   console.log("Your browser doesn't support geolocation feature!")
         //} else {
         //   setInterval(() => {
         //       navigator.geolocation.getCurrentPosition(getPosition)
         //   }, 1000);
         //};

        // location params
         var marker, circle, lat, long, accuracy;

            function getPosition(position) {
                // console.log(position)
                lat = position.coords.latitude
                long = position.coords.longitude
                accuracy = position.coords.accuracy

                if (marker) {
                    map.removeLayer(marker)
                }

                if (circle) {
                    map.removeLayer(circle)
                }

                marker = L.marker([lat, long])
                circle = L.circle([lat, long], { radius: accuracy })

                var featureGroup = L.featureGroup([marker, circle]).addTo(map)

                map.fitBounds(featureGroup.getBounds())

                console.log("Your coordinate is: Lat: " + lat + " Long: " + long + " Accuracy: " + accuracy)
            }
     }


    </script>


    <div id='chart' class='chart' style = "width: 900px; height: 580px"></div>
    <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
    <script type='text/javascript'>
    var graphs = {{graphJSON|safe}};
    Plotly.plot('chart',graphs,{});
    </script>

{% endblock %}
